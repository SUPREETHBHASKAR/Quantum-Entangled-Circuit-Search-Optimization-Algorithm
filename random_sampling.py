import numpy as np
import pandas as pd
import os


def random_knapsack_sampling(profits, weights, capacity, num_trials=5, samples_per_trial=100,
                             output_dir="knapsack_trials"):
    """
    Randomly samples solutions for the 0-1 Knapsack problem and saves results per trial in CSV files.
    Each file contains fitness + solution, and ends with the best and worst solutions.
    """
    n = len(profits)
    os.makedirs(output_dir, exist_ok=True)  # Ensure directory exists

    for trial in range(1, num_trials + 1):
        results = []

        for _ in range(samples_per_trial):
            solution = np.random.randint(0, 2, size=n)  # Random binary vector
            total_weight = np.dot(solution, weights)
            total_profit = np.dot(solution, profits)

            # Feasibility check
            fitness = total_profit if total_weight <= capacity else 0

            results.append((fitness, "".join(map(str, solution)), total_weight))

        # Convert to DataFrame
        df = pd.DataFrame(results, columns=["Fitness", "Solution", "Weight"])

        # Find best and worst solutions
        best_idx = df["Fitness"].idxmax()
        worst_idx = df["Fitness"].idxmin()

        best_row = df.iloc[best_idx]
        worst_row = df.iloc[worst_idx]

        # Append best & worst to the end, with a "Type" column
        df["Type"] = ""
        df.loc[best_idx, "Type"] = "Best (Original Position)"
        df.loc[worst_idx, "Type"] = "Worst (Original Position)"

        df = pd.concat([df,
                        pd.DataFrame([{"Fitness": best_row["Fitness"], "Solution": best_row["Solution"],
                                       "Weight": best_row["Weight"], "Type": "Best"}]),
                        pd.DataFrame([{"Fitness": worst_row["Fitness"], "Solution": worst_row["Solution"],
                                       "Weight": worst_row["Weight"], "Type": "Worst"}])
                        ], ignore_index=True)

        # Save CSV file
        output_file = os.path.join(output_dir, f"trial_{trial}.csv")
        df.to_csv(output_file, index=False)

        print(
            f"Trial {trial}: Best fitness = {best_row['Fitness']}, Worst fitness = {worst_row['Fitness']} saved in {output_file}")


# ==============================
# Example datasets
# ==============================

# Dataset 1
profits = np.array([
    456, 302, 1047, 704, 469, 271, 612, 252, 422, 587, 964, 741, 520, 898, 490, 448, 734, 411, 551, 752, 738, 416, 768, 651, 361, 305, 640, 855, 457, 957, 1019, 263, 722, 623, 625, 410, 540, 201, 967, 442, 325, 567, 664, 356, 280, 321, 375, 519, 971, 732, 403, 750, 646, 668, 566, 478, 307, 252, 770, 671, 347, 886, 276, 237, 691, 948, 618, 428, 833, 1052, 525, 730, 293, 1067, 728, 795, 276, 441, 411, 974, 415, 396, 994, 224, 872, 998, 318, 672, 668, 479, 865, 843, 1046, 463, 712, 398, 333, 1017, 606, 341, 205, 657, 286, 731, 554, 210, 199, 733, 544, 825, 397, 697, 936, 273, 499, 578, 486, 666, 478, 1022, 412, 580, 319, 318, 569, 447, 258, 839, 285, 217, 685, 421, 285, 697, 954, 775, 820, 270, 894, 349, 626, 1054, 762, 558, 639, 763, 1032, 720, 331, 729, 837, 1054, 238, 427, 973, 832, 803, 232, 785, 979, 307, 671, 259, 553, 820, 610, 735, 502, 517, 603, 544, 948, 959, 977, 275, 1038, 410, 858, 217, 960, 609, 874, 189, 746, 735, 456, 314, 548, 407, 613, 628, 992, 459, 701, 807, 759, 749, 428, 394, 264, 1064, 1038, 869, 522, 1019, 895, 949, 677, 625, 539, 1054, 901, 188, 936, 247, 688, 971, 807, 782, 992, 954, 500, 680, 274, 881, 506, 800, 577, 595, 839, 303, 496, 223, 551, 706, 352, 707, 286, 930, 483, 657, 334, 507, 721, 950, 999, 525, 680, 938, 518, 959, 626, 838, 505, 812, 358, 566, 1013, 264, 373, 330, 390, 229, 1070, 981, 517, 275, 388, 418, 939, 997, 277, 613, 658, 1070, 916, 807, 785, 482, 493, 611, 289, 1060, 597, 985, 562, 684, 583, 702, 960, 416, 791, 1019, 489, 743, 706, 746, 945, 257, 593, 549, 287, 432, 448, 603, 616, 721, 375, 953, 333, 521, 384, 824, 451, 682, 1037, 779, 395, 656, 726, 563, 1020, 393, 982, 780, 933, 269, 765, 277, 466, 805, 297, 187, 451, 595, 216, 620, 304, 1032, 470, 1069, 858, 216, 446, 470, 1063, 721, 415, 270, 351, 369, 191, 1068, 495, 727, 851, 216, 781, 198, 743, 883, 961, 425, 915, 926, 230, 272, 743, 913, 936, 849, 790, 491, 212, 519, 729, 361, 834, 302, 974, 820, 906, 345, 894, 690, 423, 180, 251, 523, 406, 421, 976, 346, 277, 303, 1012, 613, 704, 855, 717, 593, 346, 729, 293, 194, 618, 759, 918, 648, 322, 379, 1040, 692, 258, 527, 583, 699, 1006, 918, 475, 354, 928, 193, 495, 1035, 797, 621, 304, 680, 442, 642, 730, 921, 1000, 432, 347, 253, 242, 324, 691, 846, 696, 773, 1061, 635, 513, 914, 942, 811, 950, 209, 1008, 1057, 1032, 637, 762, 912, 962, 177, 961, 715, 899, 553, 740, 480, 479, 251, 310, 485, 989, 1051, 448, 695, 289, 301, 386, 229, 474, 291, 427, 685, 398, 579, 572, 918, 179, 868, 672, 330, 970, 562, 366, 592, 616, 374, 501, 199, 477, 735, 963
])

weights = np.array([
    386, 232, 977, 634, 399, 201, 542, 182, 352, 517, 894, 671, 450, 828, 420, 378, 664, 341, 481, 682, 668, 346, 698, 581, 291, 235, 570, 785, 387, 887, 949, 193, 652, 553, 555, 340, 470, 131, 897, 372, 255, 497, 594, 286, 210, 251, 305, 449, 901, 662, 333, 680, 576, 598, 496, 408, 237, 182, 700, 601, 277, 816, 206, 167, 621, 878, 548, 358, 763, 982, 455, 660, 223, 997, 658, 725, 206, 371, 341, 904, 345, 326, 924, 154, 802, 928, 248, 602, 598, 409, 795, 773, 976, 393, 642, 328, 263, 947, 536, 271, 135, 587, 216, 661, 484, 140, 129, 663, 474, 755, 327, 627, 866, 203, 429, 508, 416, 596, 408, 952, 342, 510, 249, 248, 499, 377, 188, 769, 215, 147, 615, 351, 215, 627, 884, 705, 750, 200, 824, 279, 556, 984, 692, 488, 569, 693, 962, 650, 261, 659, 767, 984, 168, 357, 903, 762, 733, 162, 715, 909, 237, 601, 189, 483, 750, 540, 665, 432, 447, 533, 474, 878, 889, 907, 205, 968, 340, 788, 147, 890, 539, 804, 119, 676, 665, 386, 244, 478, 337, 543, 558, 922, 389, 631, 737, 689, 679, 358, 324, 194, 994, 968, 799, 452, 949, 825, 879, 607, 555, 469, 984, 831, 118, 866, 177, 618, 901, 737, 712, 922, 884, 430, 610, 204, 811, 436, 730, 507, 525, 769, 233, 426, 153, 481, 636, 282, 637, 216, 860, 413, 587, 264, 437, 651, 880, 929, 455, 610, 868, 448, 889, 556, 768, 435, 742, 288, 496, 943, 194, 303, 260, 320, 159, 1000, 911, 447, 205, 318, 348, 869, 927, 207, 543, 588, 1000, 846, 737, 715, 412, 423, 541, 219, 990, 527, 915, 492, 614, 513, 632, 890, 346, 721, 949, 419, 673, 636, 676, 875, 187, 523, 479, 217, 362, 378, 533, 546, 651, 305, 883, 263, 451, 314, 754, 381, 612, 967, 709, 325, 586, 656, 493, 950, 323, 912, 710, 863, 199, 695, 207, 396, 735, 227, 117, 381, 525, 146, 550, 234, 962, 400, 999, 788, 146, 376, 400, 993, 651, 345, 200, 281, 299, 121, 998, 425, 657, 781, 146, 711, 128, 673, 813, 891, 355, 845, 856, 160, 202, 673, 843, 866, 779, 720, 421, 142, 449, 659, 291, 764, 232, 904, 750, 836, 275, 824, 620, 353, 110, 181, 453, 336, 351, 906, 276, 207, 233, 942, 543, 634, 785, 647, 523, 276, 659, 223, 124, 548, 689, 848, 578, 252, 309, 970, 622, 188, 457, 513, 629, 936, 848, 405, 284, 858, 123, 425, 965, 727, 551, 234, 610, 372, 572, 660, 851, 930, 362, 277, 183, 172, 254, 621, 776, 626, 703, 991, 565, 443, 844, 872, 741, 880, 139, 938, 987, 962, 567, 692, 842, 892, 107, 891, 645, 829, 483, 670, 410, 409, 181, 240, 415, 919, 981, 378, 625, 219, 231, 316, 159, 404, 221, 357, 615, 328, 509, 502, 848, 109, 798, 602, 260, 900, 492, 296, 522, 546, 304, 431, 129, 407, 665, 893
])
capacity = 136252


# Dataset 2 (example, you can add more and comment/uncomment)
# profits = np.array([20, 5, 10, 40, 15, 25])
# weights = np.array([1, 2, 3, 8, 7, 4])
# capacity = 10


# ==============================
# Run the sampling
# ==============================
output_directory = r"C:\Users\SupreethBhaskar\PycharmProjects\circuit_search\unifrom crossover results\500dv\500dv_sc_instance1_random_sampling"  # ðŸ‘ˆ change path as you like

random_knapsack_sampling(profits, weights, capacity,
                         num_trials=30,  # number of trial CSVs
                         samples_per_trial=1500000,  # solutions per trial
                         output_dir=output_directory)
